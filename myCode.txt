#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <locale.h>
#define _CRT_SECURE_NO_WARNINGS
#define MAXLENGT 255

typedef struct patient {
	char surname[MAXLENGT];
	char sex;
	int age;
	char city[MAXLENGT];
	char diagnosis[MAXLENGT];
}patient;

patient *array_patient = NULL;
int count_patient = 0;

void printMenu() {
	system("clear");
	if (count_patient == 0) {
		printf("Пусто\n");
	}
	else {
		for (int i = 0; i < count_patient; i++) {
			printf("%d. %s %c %d \"%s\" \"%s\" \n", i + 1, array_patient[i].surname, array_patient[i].sex, array_patient[i].age, array_patient[i].city, array_patient[i].diagnosis);
		}
	}
}

void add(patient temp) {
	if (!array_patient) {
		array_patient = (patient*)malloc(sizeof(patient));
		array_patient[count_patient].age = temp.age;
		strcpy(array_patient[count_patient].city, temp.city);
		strcpy(array_patient[count_patient].diagnosis, temp.diagnosis);
		array_patient[count_patient].sex = temp.sex;
		strcpy(array_patient[count_patient].surname, temp.surname);
	}
	else {
		array_patient = (patient*)realloc(array_patient, sizeof(patient)*(count_patient+1));
		array_patient[count_patient].age = temp.age;
		strcpy(array_patient[count_patient].city, temp.city);
		strcpy(array_patient[count_patient].diagnosis, temp.diagnosis);
		array_patient[count_patient].sex = temp.sex;
		strcpy(array_patient[count_patient].surname, temp.surname);
	}
	++count_patient;
	system("read -p \"Для продолжения нажмите любую клавишу . . .\"");
}

void addMenu() {
	patient temp;
	system("clear");
	printf("Фамилия: ");
	scanf("%s", &temp.surname);
	printf("Пол: ");
	getchar();
	scanf("%c", &temp.sex);
	printf("Возраст: ");
	scanf("%d", &temp.age);
	printf("Место проживания: ");
	getchar();
	gets(&temp.city);
	printf("Диагноз: ");
	gets(&temp.diagnosis);
	
	add(temp);
}

void delete(int index) {
	if (count_patient == 1) {
		--count_patient;
		free(array_patient);
		array_patient = NULL;
		return;
	}

	patient* temp_array = (patient*)malloc(sizeof(patient)*count_patient - 1);
	for (int i = 0, j = 0; i < count_patient; i++, j++) {
		if (i == index) {
			++i;
			if (i >= count_patient)
				break;
		}
		temp_array[j].age = array_patient[i].age;
		strcpy(temp_array[j].city, array_patient[i].city);
		strcpy(temp_array[j].diagnosis, array_patient[i].diagnosis);
		temp_array[j].sex = array_patient[i].sex;
		strcpy(temp_array[j].surname, array_patient[i].surname);
	}
	--count_patient;
	free(array_patient);
	array_patient = temp_array;
}

void deleteMenu() {
	system("clear");
	printMenu();
	if (array_patient) {
		int del;
		printf("\nВведите номер пациента для удаления (0 - для выхода): ");
		scanf("%d", &del);
		if (del == 0)
			return;
		else {
			if (del < 0 || del > count_patient)
				printf("Введен некорректный номер пациента\n");
			else {
				delete(del - 1);
			}
		}

	}
	system("read -p \"Для продолжения нажмите любую клавишу . . .\"");
}

void printPensAge() {
	char flag = 0;
	system("clear");
	if (count_patient == 0) {
		printf("Пусто\n");
	}
	else {
		for (int i = 0; i < count_patient; i++) {
			if (array_patient[i].age >= 60) {
				printf("%d. %s %c %d \"%s\" \"%s\" \n", i + 1, array_patient[i].surname, array_patient[i].sex, array_patient[i].age, array_patient[i].city, array_patient[i].diagnosis);
				if (!flag)
					flag = 1;
			}
		}
		if (!flag)
			printf("Такие пациенты отсутствуют\n");
	}
}

void writeInFile(const char* filename) {
	FILE* file = fopen(filename, "wb+");
	if (!file) {
		perror("Ошибка открытия/создания файла");
		exit(1);
	}
	fwrite(&count_patient, sizeof(int), 1, file);
	fwrite(array_patient, sizeof(patient), count_patient, file);
}

void readFile(FILE* file) {
	fread(&count_patient, sizeof(int), 1, file);
	array_patient = (patient*)malloc(sizeof(patient)*count_patient);
	fread(array_patient, sizeof(patient), count_patient, file);
}

int main(int argc, char *argv[]) {
	setlocale(LC_ALL, "Russian");
	FILE* file = NULL;
	char filename[MAXLENGT], sym;
	if (argc > 1)
		strcpy(&filename, argv[1]);
	else {
		printf("Введите название файла: ");
		scanf("%s", filename);
	}

	if (!(file = fopen(filename, "rb+"))) {
		perror("Ошибка открытия файла");
		do {
			printf("\nСоздать новый файл с таким же именем ? (Y, N): ");
			while (getchar() != '\n');
			sym = getchar();
			if (sym == 'Y') {
				if (!(file = fopen(filename, "wb"))) {
					perror("Ошибка создания файла");
					return 1;
				}
				break;
			}
			else
				if (sym == 'N')
					return 0;
		} while (1);
	}
	else
		readFile(file);

	int dig = 0;
	do {
		system("clear");
		printf("1. Добавить запись о пациенте\n");
		printf("2. Удалить запись о пациенте\n");
		printf("3. Просмотр информации о всех пациентах\n");
		printf("4. Просмотр информации о пациентах пенсионного возраста\n");
		printf("0. Выйти и сохранить\n");
		scanf("%d", &dig);
		switch (dig)
		{
			case 1: addMenu(); break;
			case 2: deleteMenu(); break;
			case 3: printMenu(); system("read -p \"Для продолжения нажмите любую клавишу . . .\""); break;
			case 4: printPensAge(); system("read -p \"Для продолжения нажмите любую клавишу . . .\""); break;
		}
	} while (dig !=0);
	writeInFile(filename);
	return 0;
}

